<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Board Game Picker (variable players + veto)</title>
  <style>
    :root { --gap: 14px; --radius: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0d12; color: #e9eef7; }
    header { padding: 18px 18px 8px; border-bottom: 1px solid #232836; }
    h1 { font-size: 18px; margin: 0 0 6px; }
    p  { margin: 0 0 10px; color: #b9c2d6; font-size: 13px; line-height: 1.35; }
    main { padding: 18px; display: grid; gap: var(--gap); max-width: 1200px; margin: 0 auto; }
    .card { background: #121726; border: 1px solid #232836; border-radius: var(--radius); padding: 14px; }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; align-items:center; justify-content:space-between; }
    .left { display:flex; gap: var(--gap); flex-wrap: wrap; align-items:center; }
    button {
      border: 1px solid #2a3246; background: #19223a; color: #e9eef7;
      padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600;
    }
    button:hover { border-color: #8bd5ff; }
    button.primary { background: #2b6cff; border-color: #2b6cff; }
    button.primary:hover { filter: brightness(1.05); }
    .muted { color: #b9c2d6; font-size: 12px; }
    input[type="number"], input[type="text"], select {
      border-radius: 10px; border: 1px solid #2a3246; background: #0f1421; color:#e9eef7;
      padding: 10px; font-size: 13px; outline: none;
    }
    input[type="number"] { width: 110px; }
    select { padding-right: 30px; }
    input:focus, select:focus { border-color: #8bd5ff; box-shadow: 0 0 0 3px rgba(139,213,255,.15); }
    .grid { display: grid; gap: var(--gap); grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .player { display:flex; flex-direction:column; gap:10px; }
    .player h2 { font-size: 14px; margin: 0; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .badge { font-size: 12px; color: #0b0d12; background: #8bd5ff; padding: 2px 8px; border-radius: 999px; }
    textarea {
      width: 100%; min-height: 170px; resize: vertical; border-radius: 10px;
      border: 1px solid #2a3246; background: #0f1421; color: #e9eef7;
      padding: 10px; font-size: 13px; line-height: 1.35; outline: none;
    }
    textarea:focus { border-color: #8bd5ff; box-shadow: 0 0 0 3px rgba(139,213,255,.15); }
    .tiny { font-size: 11px; color:#8a95ad; }
    .results { display:grid; grid-template-columns: 1.25fr .75fr; gap: var(--gap); }
    @media (max-width: 980px) { .results { grid-template-columns: 1fr; } }
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; border: 1px solid #232836; }
    th, td { padding: 10px 10px; border-bottom: 1px solid #232836; font-size: 13px; vertical-align: top; }
    th { text-align: left; background: #0f1421; color: #b9c2d6; font-weight: 700; }
    tr:last-child td { border-bottom: 0; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #2a3246; background:#0f1421; font-size: 12px; color:#b9c2d6; }
    .good { border-color:#2bd4a8; color:#2bd4a8; }
    .warn { border-color:#ffcf5a; color:#ffcf5a; }
    .bad  { border-color:#ff6b6b; color:#ff6b6b; }
    .footer-note { padding: 10px 14px; border-radius: 12px; border: 1px dashed #2a3246; background:#0f1421; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
<header>
  <h1>üé≤ Board Game Picker (variable players + veto)</h1>
  <p>
    Each player enters a ranked list (<b>one game per line</b>, top = most wanted). Unlisted games = <b>0</b> points (neutral).
    Vetoes are entered separately and can exclude games from the suggestion.
  </p>
</header>

<main>
  <div class="card">
    <div class="row">
      <div class="left">
        <button class="primary" id="calcBtn">Calculate</button>
        <button id="clearBtn">Clear</button>
        <button id="exampleBtn">Load example</button>
      </div>

      <div class="left">
        <label class="muted">Players</label>
        <input id="playerCount" type="number" min="2" max="12" step="1" value="3" />
        <button id="applyPlayersBtn">Apply</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="left">
        <span class="muted">Optional: shared pool (comma separated)</span>
        <input id="pool" type="text" placeholder="e.g. Dune Imperium, Ark Nova, Cascadia, Azul" style="width:min(520px, 100%);" />
        <button id="fillFromPoolBtn">Fill missing from pool</button>
      </div>

      <div class="left">
        <span class="muted">Veto rule</span>
        <select id="vetoMode">
          <option value="any">Exclude if ANY player vetoes</option>
          <option value="threshold">Exclude if vetoes ‚â• threshold</option>
        </select>
        <label class="muted nowrap">Threshold</label>
        <input id="vetoThreshold" type="number" min="1" max="12" step="1" value="1" />
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      Scoring: N is the number of games from the longest list, #1 gets N points, #2 gets N-1 ‚Ä¶ last gets 1. Unlisted = 0.
      Sorting tie-breakers: higher ‚Äúin lists‚Äù ‚Üí better best rank ‚Üí alphabetical.
    </div>
  </div>

  <div id="playersGrid" class="grid"></div>

  <div class="results">
    <div class="card">
      <h2 style="margin:0 0 10px; font-size:14px;">Results</h2>
      <div id="recommendation" class="footer-note" style="margin-bottom:12px;">
        Enter lists and press <b>Calculate</b>.
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:40px;">#</th>
            <th>Game</th>
            <th style="width:90px;">Score</th>
            <th style="width:120px;">In lists</th>
            <th style="width:110px;">Best rank</th>
            <th style="width:150px;">Vetoes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="muted" style="margin-top:10px;">
        Suggested pick ignores vetoed games (per your veto rule). Vetoed games remain visible in the table.
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px; font-size:14px;">Quick insights</h2>
      <div id="insights" class="footer-note">‚Äî</div>

      <div class="footer-note" style="margin-top:12px;">
        <b>Tip:</b> If you want ‚Äúsafe picks‚Äù, look for <span class="pill warn">2+/N</span> or <span class="pill good">N/N</span>
        in the ‚ÄúIn lists‚Äù column, and <span class="pill bad">vetoed</span> should usually be avoided.
      </div>
    </div>
  </div>
</main>

<script>
  const LS_KEY = "boardgame_picker_v2";

  const els = {
    playersGrid: document.getElementById('playersGrid'),
    tbody: document.getElementById('tbody'),
    recommendation: document.getElementById('recommendation'),
    insights: document.getElementById('insights'),
    calcBtn: document.getElementById('calcBtn'),
    clearBtn: document.getElementById('clearBtn'),
    exampleBtn: document.getElementById('exampleBtn'),
    pool: document.getElementById('pool'),
    fillFromPoolBtn: document.getElementById('fillFromPoolBtn'),
    playerCount: document.getElementById('playerCount'),
    applyPlayersBtn: document.getElementById('applyPlayersBtn'),
    vetoMode: document.getElementById('vetoMode'),
    vetoThreshold: document.getElementById('vetoThreshold'),
  };

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, (c) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[c]));
  }

  function normalizeName(s) {
    return (s || "")
      .trim()
      .replace(/\s+/g, " ")
      .toLowerCase();
  }

  function parseLines(text) {
    const lines = (text || "")
      .split(/\r?\n/)
      .map(x => x.trim())
      .filter(Boolean);

    const seen = new Set();
    const out = [];
    for (const line of lines) {
      const key = normalizeName(line);
      if (!key || seen.has(key)) continue;
      seen.add(key);
      out.push(line.replace(/\s+/g, " "));
    }
    return out;
  }

  function parsePool() {
    return (els.pool.value || "")
      .split(",")
      .map(x => x.trim())
      .filter(Boolean);
  }

  function stateGet() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }

  function stateSet(payload) {
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  }

  function buildPlayerCards(playerCount, existingState) {
    els.playersGrid.innerHTML = "";

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    for (let i = 0; i < playerCount; i++) {
      const badge = letters[i] || String(i + 1);
      const card = document.createElement("div");
      card.className = "card player";

      const header = document.createElement("h2");
      header.innerHTML = `Player ${i + 1} <span class="badge">${badge}</span>`;
      card.appendChild(header);

      const rankLabel = document.createElement("div");
      rankLabel.className = "muted";
      rankLabel.innerHTML = `Ranked list <span class="tiny">(one per line; top = most wanted)</span>`;
      card.appendChild(rankLabel);

      const rankTa = document.createElement("textarea");
      rankTa.id = `rank_${i}`;
      rankTa.placeholder = "One game per line";
      rankTa.value = (existingState?.players?.[i]?.ranked) ?? "";
      card.appendChild(rankTa);

      const vetoLabel = document.createElement("div");
      vetoLabel.className = "muted";
      vetoLabel.innerHTML = `Veto list <span class="tiny">(one per line; games you refuse to play)</span>`;
      card.appendChild(vetoLabel);

      const vetoTa = document.createElement("textarea");
      vetoTa.id = `veto_${i}`;
      vetoTa.placeholder = "One game per line";
      vetoTa.style.minHeight = "120px";
      vetoTa.value = (existingState?.players?.[i]?.veto) ?? "";
      card.appendChild(vetoTa);

      const hint = document.createElement("div");
      hint.className = "tiny";
      hint.textContent = "Duplicates ignored. Matching is case-insensitive (Ark Nova == ark nova).";
      card.appendChild(hint);

      // autosave
      rankTa.addEventListener("input", saveState);
      vetoTa.addEventListener("input", saveState);

      els.playersGrid.appendChild(card);
    }
  }

  function readPlayers() {
    const n = Number(els.playerCount.value || 3);
    const players = [];
    for (let i = 0; i < n; i++) {
      const ranked = parseLines(document.getElementById(`rank_${i}`)?.value || "");
      const veto = parseLines(document.getElementById(`veto_${i}`)?.value || "");
      players.push({ ranked, veto });
    }
    return players;
  }

  function saveState() {
    const players = [];
    const n = Number(els.playerCount.value || 3);
    for (let i = 0; i < n; i++) {
      players.push({
        ranked: document.getElementById(`rank_${i}`)?.value ?? "",
        veto: document.getElementById(`veto_${i}`)?.value ?? "",
      });
    }
    stateSet({
      playerCount: n,
      pool: els.pool.value || "",
      vetoMode: els.vetoMode.value || "any",
      vetoThreshold: Number(els.vetoThreshold.value || 1),
      players
    });
  }

  function loadState() {
    const s = stateGet();
    if (!s) return null;
    if (s.playerCount) els.playerCount.value = s.playerCount;
    if (typeof s.pool === "string") els.pool.value = s.pool;
    if (s.vetoMode) els.vetoMode.value = s.vetoMode;
    if (s.vetoThreshold != null) els.vetoThreshold.value = s.vetoThreshold;
    return s;
  }

  function fillMissingFromPool() {
    const pool = parsePool();
    if (pool.length === 0) return;

    const n = Number(els.playerCount.value || 3);
    const poolPairs = pool.map(v => ({ raw: v, key: normalizeName(v) }));

    for (let i = 0; i < n; i++) {
      const ta = document.getElementById(`rank_${i}`);
      if (!ta) continue;
      const list = parseLines(ta.value);
      const existing = new Set(list.map(normalizeName));
      const missing = poolPairs.filter(p => !existing.has(p.key)).map(p => p.raw);
      ta.value = list.concat(missing).join("\n");
    }
    saveState();
  }

  function vetoRuleExcludes(vetoCount) {
    const mode = els.vetoMode.value;
    const threshold = Math.max(1, Number(els.vetoThreshold.value || 1));
    if (mode === "any") return vetoCount >= 1;
    return vetoCount >= threshold;
  }

  function calculate() {
    const players = readPlayers();
    const nPlayers = players.length;
    const maxRanked = Math.max(0, ...players.map(p => p.ranked.length));

    // display name per key (first seen)
    const display = new Map();

    // per-player rank map: key -> rank (1-based)
    const rankMaps = players.map(p => {
      const m = new Map();
      p.ranked.forEach((name, idx) => {
        const key = normalizeName(name);
        if (!display.has(key)) display.set(key, name);
        m.set(key, idx + 1);
      });
      return m;
    });

    // per-player veto set: key
    const vetoSets = players.map(p => {
      const s = new Set();
      p.veto.forEach(name => {
        const key = normalizeName(name);
        if (!display.has(key)) display.set(key, name);
        s.add(key);
      });
      return s;
    });

    // all keys appearing anywhere (ranked or veto)
    const allKeys = new Set();
    rankMaps.forEach(m => m.forEach((_, k) => allKeys.add(k)));
    vetoSets.forEach(s => s.forEach(k => allKeys.add(k)));

    const rows = [];
    for (const key of allKeys) {
      let score = 0;
      let inLists = 0;
      let bestRank = Infinity;

      for (let i = 0; i < nPlayers; i++) {
        const m = rankMaps[i];
        const rank = m.get(key);
        const N = maxRanked;
        if (rank != null) {
          inLists += 1;
          bestRank = Math.min(bestRank, rank);
          score += (N - rank + 1); // Borda
        }
      }

      let vetoes = 0;
      const vetoBy = [];
      for (let i = 0; i < nPlayers; i++) {
        if (vetoSets[i].has(key)) {
          vetoes += 1;
          vetoBy.push(i + 1);
        }
      }

      rows.push({
        key,
        name: display.get(key) || key,
        score,
        inLists,
        bestRank: bestRank === Infinity ? null : bestRank,
        vetoes,
        vetoBy,
        vetoExcluded: vetoRuleExcludes(vetoes),
      });
    }

    // Sort results (table) by score + tie-breakers
    rows.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      if (b.inLists !== a.inLists) return b.inLists - a.inLists;
      const ar = a.bestRank ?? 9999;
      const br = b.bestRank ?? 9999;
      if (ar !== br) return ar - br;
      return a.name.localeCompare(b.name);
    });

    render(rows, nPlayers);
  }

  function inListsPill(inLists, nPlayers) {
    if (inLists === nPlayers) return `<span class="pill good">${inLists}/${nPlayers}</span>`;
    if (inLists >= Math.ceil(nPlayers / 2)) return `<span class="pill warn">${inLists}/${nPlayers}</span>`;
    return `<span class="pill">${inLists}/${nPlayers}</span>`;
  }

  function render(rows, nPlayers) {
    els.tbody.innerHTML = "";

    if (rows.length === 0) {
      els.recommendation.innerHTML = "No games entered yet.";
      els.insights.innerHTML = "‚Äî";
      return;
    }

    // Suggested pick: first non-excluded game in sorted order
    const pick = rows.find(r => !r.vetoExcluded) || null;

    if (pick) {
      const vetoInfo = pick.vetoes
        ? ` <span class="pill bad">vetoed by ${pick.vetoes}</span>`
        : "";
      els.recommendation.innerHTML =
        `<b>Suggested pick:</b> ${escapeHtml(pick.name)} ` +
        `${inListsPill(pick.inLists, nPlayers)}${vetoInfo}` +
        `<br/><span class="muted">Why: highest score among non-vetoed games. Score ${pick.score}. Best rank ${pick.bestRank ? "#" + pick.bestRank : "‚Äî"}.</span>`;
    } else {
      els.recommendation.innerHTML =
        `<b>No suggestion:</b> all listed games are excluded by the current veto rule. Try lowering the veto threshold or clearing vetoes.`;
    }

    // Table
    rows.forEach((r, idx) => {
      const tr = document.createElement("tr");

      const tdIdx = document.createElement("td");
      tdIdx.textContent = String(idx + 1);
      tr.appendChild(tdIdx);

      const tdName = document.createElement("td");
      tdName.innerHTML = escapeHtml(r.name) + (r.vetoExcluded ? ` <span class="pill bad">excluded</span>` : "");
      tr.appendChild(tdName);

      const tdScore = document.createElement("td");
      tdScore.textContent = String(r.score);
      tr.appendChild(tdScore);

      const tdIn = document.createElement("td");
      tdIn.innerHTML = inListsPill(r.inLists, nPlayers);
      tr.appendChild(tdIn);

      const tdBest = document.createElement("td");
      tdBest.textContent = r.bestRank ? `#${r.bestRank}` : "‚Äî";
      tr.appendChild(tdBest);

      const tdV = document.createElement("td");
      if (r.vetoes) {
        tdV.innerHTML = `<span class="pill bad">${r.vetoes}</span> <span class="tiny">by P${r.vetoBy.join(", P")}</span>`;
      } else {
        tdV.innerHTML = `<span class="pill">0</span>`;
      }
      tr.appendChild(tdV);

      els.tbody.appendChild(tr);
    });

    // Insights
    const consensus = rows.filter(r => r.inLists === nPlayers && !r.vetoExcluded).slice(0, 10);
    const halfOrMore = rows.filter(r => r.inLists >= Math.ceil(nPlayers / 2) && !r.vetoExcluded).slice(0, 10);
    const excluded = rows.filter(r => r.vetoExcluded).slice(0, 10);

    let html = `<div><b>Players:</b> ${nPlayers}</div>`;
    html += `<div style="margin-top:8px;"><b>Consensus (all listed, non-vetoed):</b> ${consensus.length ? consensus.map(r => escapeHtml(r.name)).join(", ") : "<span class='muted'>none</span>"}</div>`;
    html += `<div style="margin-top:8px;"><b>Safer pool (‚â• half listed, non-vetoed):</b> ${halfOrMore.length ? halfOrMore.map(r => escapeHtml(r.name)).join(", ") : "<span class='muted'>none</span>"}</div>`;
    html += `<div style="margin-top:8px;"><b>Excluded by veto rule:</b> ${excluded.length ? excluded.map(r => escapeHtml(r.name)).join(", ") : "<span class='muted'>none</span>"}</div>`;
    html += `<div style="margin-top:10px;" class="muted">Veto rule: <span class="kbd">${escapeHtml(document.querySelector("#vetoMode option:checked").textContent)}</span></div>`;

    els.insights.innerHTML = html;
  }

  // Buttons / events
  els.calcBtn.addEventListener("click", () => { saveState(); calculate(); });

  els.applyPlayersBtn.addEventListener("click", () => {
    const n = Math.max(2, Math.min(12, Number(els.playerCount.value || 3)));
    els.playerCount.value = n;

    // Preserve existing state where possible
    const current = stateGet() || {};
    const oldPlayers = current.players || [];
    const newPlayers = Array.from({length: n}, (_, i) => ({
      ranked: oldPlayers[i]?.ranked ?? "",
      veto: oldPlayers[i]?.veto ?? ""
    }));

    const next = {
      playerCount: n,
      pool: els.pool.value || "",
      vetoMode: els.vetoMode.value || "any",
      vetoThreshold: Number(els.vetoThreshold.value || 1),
      players: newPlayers
    };

    stateSet(next);
    buildPlayerCards(n, next);
  });

  els.clearBtn.addEventListener("click", () => {
    const n = Math.max(2, Math.min(12, Number(els.playerCount.value || 3)));
    els.pool.value = "";
    els.vetoMode.value = "any";
    els.vetoThreshold.value = 1;

    const blank = {
      playerCount: n,
      pool: "",
      vetoMode: "any",
      vetoThreshold: 1,
      players: Array.from({length: n}, () => ({ ranked: "", veto: "" }))
    };
    stateSet(blank);
    buildPlayerCards(n, blank);

    els.tbody.innerHTML = "";
    els.recommendation.innerHTML = "Cleared.";
    els.insights.innerHTML = "‚Äî";
  });

  els.exampleBtn.addEventListener("click", () => {
    els.playerCount.value = 4;
    els.vetoMode.value = "threshold";
    els.vetoThreshold.value = 2;
    els.pool.value = "Dune: Imperium, Ark Nova, Terraforming Mars, Cascadia, Azul, Splendor, Lost Ruins of Arnak";

    const ex = {
      playerCount: 4,
      pool: els.pool.value,
      vetoMode: "threshold",
      vetoThreshold: 2,
      players: [
        { ranked: ["Dune: Imperium","Ark Nova","Cascadia","Azul"].join("\n"), veto: ["Terraforming Mars"].join("\n") },
        { ranked: ["Ark Nova","Terraforming Mars","Dune: Imperium","Cascadia"].join("\n"), veto: ["Azul"].join("\n") },
        { ranked: ["Cascadia","Dune: Imperium","Splendor","Azul"].join("\n"), veto: ["Terraforming Mars"].join("\n") },
        { ranked: ["Lost Ruins of Arnak","Dune: Imperium","Cascadia"].join("\n"), veto: ["Splendor"].join("\n") },
      ]
    };

    stateSet(ex);
    buildPlayerCards(ex.playerCount, ex);
    calculate();
  });

  els.fillFromPoolBtn.addEventListener("click", () => { fillMissingFromPool(); calculate(); });

  // Save changes to these inputs too
  [els.pool, els.vetoMode, els.vetoThreshold, els.playerCount].forEach(el => el.addEventListener("input", saveState));

  // Init
  const s = loadState();
  const initialN = Math.max(2, Math.min(12, Number(els.playerCount.value || 3)));
  els.playerCount.value = initialN;
  buildPlayerCards(initialN, s || null);
</script>
</body>
</html>
